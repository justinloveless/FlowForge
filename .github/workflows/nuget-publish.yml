name: Publish NuGet Packages

on:
  push:
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Fetch the full Git history
          ref: main
          fetch-tags: true
          
      - name: Fetch main branch
        run: git fetch origin main:refs/remotes/origin/main

      - name: Configure Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
      - name: Debug Git state
        run: |
         echo "Current branch: $(git branch --show-current)"
         echo "HEAD: $(git rev-parse HEAD)"
         git branch -r
         git log --oneline --graph --decorate --all -n 10
      
      - name: Determine changed projects
        id: changes
        run: |
          # Determine the merge base
          merge_base=$(git merge-base HEAD origin/main || echo "")
          echo "got merge_base"
          echo $merge_base
          
          if [ -z "$merge_base" ]; then
          echo "No merge base found. Skipping project detection."
          echo "" > changed_projects.txt
          else
          # Get a list of changed files between the merge base and HEAD
          echo "Getting git diff"
          git diff --name-only $merge_base HEAD | \
          grep '^FlowForge' | awk -F'/' '{print $1}' | sort | uniq > changed_projects.txt
          fi
          
          # Export the list of projects as a comma-separated environment variable
          echo "projects=$(cat changed_projects.txt | tr '\n' ',')" >> $GITHUB_ENV
        shell: bash
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0'

      - name: Restore dependencies
        run: dotnet restore


      - name: Publish changed projects
        if: env.projects != ''
        run: |
          for project in $(echo "$projects" | tr ',' '\n'); do
            echo "Publishing $project"
            cd $project
            # Clean the working directory for the current project
            git clean -fdx
            # Ensure version is updated based on Git history
            nbgv prepare-release
            # Build the project
            dotnet build --configuration Release
            # Pack the project with output to a temporary directory
            OUTPUT_DIR=/tmp/output
            mkdir -p $OUTPUT_DIR
            dotnet pack -o $OUTPUT_DIR --configuration Release
            for nupkg in $OUTPUT_DIR/*.nupkg; do
              dotnet nuget push "$nupkg" --api-key ${{ secrets.NUGETAPIKEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
            done
            cd -
          done
        env:
          projects: ${{ env.projects }}
          
      - name: Clean working directory
        run: git clean -fdx
